#!/bin/bash
#
# Mock cec-client for TV simulation testing
# Handles both monitor mode (watch trigger file) and power queries
#

TRIGGER_FILE="/tmp/toasttv-cec-trigger"
POWER_STATE="/tmp/toasttv-power-state"

# Handle power query: echo "pow 0" | cec-client -s -d 1
if [[ "$1" == "-s" ]]; then
    # Single command mode - read from stdin
    read -r cmd
    if [[ "$cmd" == "pow 0" ]]; then
        # Return power status from state file
        if [[ -f "$POWER_STATE" ]]; then
            STATE=$(cat "$POWER_STATE")
            echo "power status: $STATE"
        else
            echo "power status: unknown"
        fi
    fi
    exit 0
fi

# Initialize trigger file
touch "$TRIGGER_FILE"

echo "waiting for input"

# Monitor mode - watch trigger file for new content
while true; do
    if [[ -s "$TRIGGER_FILE" ]]; then
        # Output contents and clear
        cat "$TRIGGER_FILE"
        > "$TRIGGER_FILE"
    fi
    sleep 0.2
done
